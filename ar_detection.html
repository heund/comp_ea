<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="열간 압연 데이터 01: 보정 알고리즘 구조">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="manifest" href="./manifest.json">
    <title>열간 압연 데이터 01: 보정 알고리즘 구조</title>
    
    <!-- A-Frame for AR -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for marker tracking -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <!-- Three.js for 3D visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- D3.js for data visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <!-- Bootstrap Icons for UI buttons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Navigation Buttons CSS Only -->
    <link rel="stylesheet" href="./shared/nav-buttons.css">
    <!-- Global Styles -->
    <link rel="stylesheet" href="./shared/style.css">
</head>
<body>
    <div class="ar-detection-container" id="arDetection">
        <div class="ar-detection-box" id="arDetectionBox"></div>
        <div class="ar-detection-text" id="arDetectionText">AR 마커를 스캔해주세요</div>
    </div>
    
    <!-- Three.js Visualization Container -->
    <div class="visualization-container" id="visualizationContainer">
        <canvas id="visualizationCanvas"></canvas>
    </div>
    
    <!-- Wave Visualization Container for Artwork3 -->
    <div class="wave-container" id="waveContainer">
        <canvas id="waveCanvas" width="1920" height="1080"></canvas>
    </div>
    
    <!-- Thermal Visualization Container for Artwork5 - Now dynamically created by artwork5.js -->
        
        <!-- Futuristic Data Overlay - EXACT copy from artwork1.html -->
        <div class="data-overlay" id="dataOverlay">
            <div class="overlay-rings">
                <div class="ring"></div>
                <div class="ring"></div>
            </div>
            <div class="data-content">
                <div class="metric-value-large" id="metricValue">1247</div>
                <div class="metric-unit" id="metricUnit">kN</div>
                <div class="metric-label-large" id="metricLabel">Rolling<br>Force</div>
            </div>
            <div class="data-overlay-close" id="overlayClose">×</div>
        </div>
    </div>
    
    <!-- AR Title - Now independent from controls -->
    <div class="ar-title-container">
        <div class="ar-title">AR 작품 시각화</div>
    </div>
    
    <!-- AR Controls with Bootstrap Icons -->
    <div class="ar-controls-container">
        <div class="ar-controls">
            <button class="control-btn" id="dataBtn" title="Reveal Data">
                <i class="bi bi-bar-chart"></i>
            </button>
            <button class="control-btn" id="audioBtn" title="Toggle Audio">
                <i class="bi bi-volume-up"></i>
            </button>
            <button class="control-btn" id="exitBtn" title="Exit to Gallery">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>
    </div>
    
    <!-- A-Frame AR Scene -->
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
        vr-mode-ui="enabled: false"
        id="arScene">
        
        <!-- AR Markers for different artworks -->
        
        <!-- Artwork1 Marker - pattern-ar_code_test1.patt -->
        <a-marker
            type="pattern"
            url="./pattern-ar_code_test1.patt"
            id="artwork1"
            smooth="true">
            <!-- Artwork1 Marker -->
        </a-marker>
        
        <!-- Artwork2 Marker - pattern-ar_code_test2.patt -->
        <a-marker
            type="pattern"
            url="./pattern-ar_code_test2.patt"
            id="artwork2"
            smooth="true">
            <!-- Artwork2 Marker -->
        </a-marker>
        
        <!-- Artwork3 Marker - pattern-D1.patt -->
        <a-marker
            type="pattern"
            url="./pattern-D1.patt"
            id="artwork3"
            smooth="true">
            <!-- Artwork3 Marker -->
        </a-marker>
        
        <!-- Artwork4 Marker - Hiro -->
        <a-marker
            preset="hiro"
            id="artwork4"
            smooth="true">
            <!-- Artwork4 Marker -->
        </a-marker>
        
        <!-- Artwork5 Marker - Kanji -->
        <a-marker
            preset="kanji"
            id="artwork5"
            smooth="true">
            <!-- Artwork5 Marker -->
        </a-marker>
        
        <!-- Camera -->
        <a-camera></a-camera>
    </a-scene>
    
    <!-- Glassmorphism Loading Screen -->
    <div id="loadingScreen" class="glassmorphism-loading">
        <div class="loading-spinner"></div>
    </div>
    
    <style>
        /* Glassmorphism Loading Screen */
        .glassmorphism-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }
        
        /* Simple black background */
        .glassmorphism-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            z-index: -2;
            opacity: 1;
        }
        
        /* Glassmorphism overlay */
        .glassmorphism-loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            z-index: -1;
        }
        
        .glassmorphism-loading.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
            z-index: 1;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Wave Visualization Container */
        .wave-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .wave-container.active {
            opacity: 1;
            visibility: visible;
        }

        .wave-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Thermal CSS styles moved to artwork5.js for self-contained module */
        
        /* Back Button Styling - Matching next-button style from metal-slab.html */
        .back-button {
            position: fixed;
            bottom: 30px;
            left: 30px;
            height: 60px;
            display: flex;
            flex-direction: row; /* Ensure horizontal layout */
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: none;
            z-index: 1000;
            background: transparent;
            box-shadow: none;
            padding: 0 15px;
            width: auto; /* Allow width to adjust to content */
            white-space: nowrap; /* Prevent text wrapping */
        }
        
        .back-button:hover {
            transform: scale(1.02);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .back-button-text {
            font-family: 'Noto Serif KR', serif;
            color: #000000;
            font-size: 16px;
            margin-right: 10px;
            font-weight: 400;
        }
        
        .back-button i {
            font-size: 24px;
            color: #000000;
        }
    </style>
    
    <!-- Artwork Module System - Using conditional loading to prevent duplicate declarations -->
    <script>
        // Check if modules are already loaded before including them
        if (typeof ArtworkModule === 'undefined') {
            const artworkModuleScript = document.createElement('script');
            artworkModuleScript.src = './shared/artwork-module.js';
            document.head.appendChild(artworkModuleScript);
        }
        
        if (typeof ARContainerManager === 'undefined') {
            const arContainerManagerScript = document.createElement('script');
            arContainerManagerScript.src = './shared/ar-container-manager.js';
            document.head.appendChild(arContainerManagerScript);
        }
        
        if (typeof Artwork1 === 'undefined') {
            const artworkTemplateScript = document.createElement('script');
            artworkTemplateScript.src = './shared/artwork1.js';
            document.head.appendChild(artworkTemplateScript);
        }
        
        if (typeof Artwork2 === 'undefined') {
            const artwork2Script = document.createElement('script');
            artwork2Script.src = './shared/artwork2.js';
            document.head.appendChild(artwork2Script);
        }
    </script>
    
    <script>
        // Loading Screen Handler
        document.addEventListener('DOMContentLoaded', function() {
            const loadingScreen = document.getElementById('loadingScreen');
            
            // Check if we're coming from metal-slab.html with loading flag
            if (sessionStorage.getItem('loading_ar') === 'true') {
                // Check if loading screen has already been shown
                const alreadyShown = sessionStorage.getItem('loading_screen_shown') === 'true';
                
                // Only show loading screen if it hasn't been shown already
                if (loadingScreen && !alreadyShown) {
                    loadingScreen.classList.add('visible');
                }
                
                // Clear the flags
                sessionStorage.removeItem('loading_ar');
                // Keep loading_screen_shown flag until AR scene is loaded
            }
        });
    </script>
    
    <script>
        // AR Container System - Modular architecture for multiple artwork markers
        // Note: The AR initialization is now handled in a single place at the bottom of the file
        
        // Disable device motion/orientation permission requests for development
        if (typeof DeviceMotionEvent !== 'undefined' && DeviceMotionEvent.requestPermission) {
            DeviceMotionEvent.requestPermission = () => Promise.resolve('denied');
        }
        if (typeof DeviceOrientationEvent !== 'undefined' && DeviceOrientationEvent.requestPermission) {
            DeviceOrientationEvent.requestPermission = () => Promise.resolve('denied');
        }
        
        // Log initial viewport info
        console.log('Page loaded - Viewport:', window.innerWidth, 'x', window.innerHeight);
        console.log('User Agent:', navigator.userAgent);
        
        // Variables for AR state tracking
        let cameraInitialized = false;
        
        // Handle loading screen state when page loads
        window.addEventListener('load', () => {
            console.log('Auto-starting AR...');
            console.log('Viewport:', window.innerWidth, 'x', window.innerHeight);
            
            // Check if we're coming from the loading screen
            if (sessionStorage.getItem('loadingScreenActive') === 'true') {
                console.log('Coming from loading screen, ensuring persistent loading screen is visible');
                // Use the persistent loading screen instead of the local one
                if (window.persistentLoadingScreen) {
                    window.persistentLoadingScreen.show();
                    window.persistentLoadingScreen.setARMode(true);
                }
                // Clear the flag
                sessionStorage.removeItem('loadingScreenActive');
            }
            
            // Listen for camera stream initialization
            const scene = document.querySelector('a-scene');
            
            // When the AR.js scene is loaded and camera is ready
            scene.addEventListener('loaded', () => {
                console.log('A-Frame scene loaded');
                
                // Ensure the persistent loading screen is visible during camera initialization
                if (window.persistentLoadingScreen) {
                    window.persistentLoadingScreen.show();
                    window.persistentLoadingScreen.setARMode(true);
                }
                
                // Give a little time for the camera to fully initialize
                setTimeout(() => {
                    cameraInitialized = true;
                    console.log('Camera initialization complete');
                    
                    // Add a timeout to hide the loading screen if no marker is found after 15 seconds
                    setTimeout(() => {
                        if (window.persistentLoadingScreen) {
                            console.log('No marker detected after timeout, hiding loading screen');
                            window.persistentLoadingScreen.hide();
                        }
                    }, 15000); // 15 seconds timeout
                }, 1000); // 1 second delay to ensure camera is fully active
            });
            
            // Make sure the persistent loading screen is visible during AR initialization
            if (window.persistentLoadingScreen) {
                window.persistentLoadingScreen.show();
                window.persistentLoadingScreen.setARMode(true);
            }
            
            // Exit button handler already set up in DOMContentLoaded
        });
        
        // Disable device motion/orientation permissions to prevent invasive prompts
        if (typeof DeviceMotionEvent !== 'undefined' && DeviceMotionEvent.requestPermission) {
            DeviceMotionEvent.requestPermission = () => Promise.resolve('denied');
        }
        if (typeof DeviceOrientationEvent !== 'undefined' && DeviceOrientationEvent.requestPermission) {
            DeviceOrientationEvent.requestPermission = () => Promise.resolve('denied');
        }
        
        // Log initial viewport info
        console.log('Page loaded - Viewport:', window.innerWidth, 'x', window.innerHeight);
        console.log('User Agent:', navigator.userAgent);
    </script>
    <!-- Navigation Buttons -->
    <button class="back-button" id="backButton">
        <span class="back-button-text">메탈 슬래브 시뮬레이션</span>
        <i class="bi bi-arrow-left"></i>
    </button>
    
    <!-- Artwork Module System -->
    <script src="./shared/artwork-module.js"></script>
    <script src="./shared/ar-container-manager.js"></script>
    <script src="./shared/artwork1.js"></script>
    <script src="./shared/artwork2.js"></script>
    <script src="./shared/artwork3.js"></script>
    <script src="./shared/artwork4.js"></script>
    <script src="./shared/artwork5.js"></script>
    
    <!-- Shared Navigation Script -->
    <script src="./shared/navigation.js"></script>
    
    <!-- Click Sound Implementation with Debounce -->  
    <script>
        // Initialize title container when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Make sure title is visible on page load
            const titleContainer = document.querySelector('.ar-title-container');
            if (titleContainer) {
                titleContainer.classList.add('ar-active');
            }
        });
        
        // Audio variables
        let clickSound = null;
        
        // Debounce variables
        let lastClickTime = 0;
        const clickDebounceTime = 100; // Minimum milliseconds between click sounds
        
        // Initialize audio system
        function initializeAudio() {
            // Initialize click sound
            clickSound = new Audio('https://heund.github.io/ea_test1/sounds/click1.wav');
            clickSound.volume = 0.3; // Set volume to 30% for subtle feedback
            clickSound.preload = 'auto';
        }
        
        // Play click sound with debounce and error handling
        function playClickSound() {
            // Debounce logic - only play if enough time has passed since last click
            const now = Date.now();
            if (now - lastClickTime < clickDebounceTime) {
                console.log('Click sound debounced');
                return; // Skip this sound - too soon after previous
            }
            
            // Update last click time
            lastClickTime = now;
            
            // Play the sound
            if (clickSound) {
                try {
                    clickSound.currentTime = 0; // Reset to beginning
                    clickSound.play().catch(e => {
                        // Silently handle audio play errors (common on mobile)
                        console.log('Audio play prevented:', e);
                    });
                } catch (error) {
                    console.log('Audio error:', error);
                }
            }
        }
        
        // Add click sound to all interactive elements
        function addClickSounds() {
            // Add click sounds to all data points
            const dataPoints = document.querySelectorAll('.data-point');
            dataPoints.forEach(point => {
                point.addEventListener('click', playClickSound);
                point.addEventListener('touchstart', playClickSound);
            });
            
            // Add click sounds to canvas interactions
            const canvas = document.querySelector('#visualizationCanvas');
            if (canvas) {
                canvas.addEventListener('click', playClickSound);
                canvas.addEventListener('touchstart', playClickSound);
            }
            
            // Add click sounds to all buttons and interactive elements
            const buttons = document.querySelectorAll('button, .interactive, .data-overlay-close, #dataBtn, #exitBtn');
            buttons.forEach(button => {
                button.addEventListener('click', playClickSound);
                button.addEventListener('touchstart', playClickSound);
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize audio
            initializeAudio();
            
            // Add click sounds to all interactive elements
            addClickSounds();
            
            const loadingScreen = document.getElementById('loadingScreen');
            
            // Initialize AR Container Manager
            window.arManager = new ARContainerManager({
                visualizationContainer: '#visualizationContainer',
                arScene: 'a-scene',
                debugMode: true
            });
            const arManager = window.arManager;
            
            console.log('ARContainerManager initialized:', arManager);
            console.log('Container element found:', arManager.container);
            
            // Add event listener to hide loading screen when AR scene is loaded
            const arScene = document.querySelector('a-scene');
            if (arScene) {
                arScene.addEventListener('loaded', function() {
                    console.log('AR scene loaded, hiding loading screen');
                    // Hide loading screen with a slight delay for smooth transition
                    setTimeout(() => {
                        if (loadingScreen) {
                            loadingScreen.classList.remove('visible');
                        }
                        // Clear the loading_screen_shown flag when AR scene is fully loaded
                        sessionStorage.removeItem('loading_screen_shown');
                    }, 1000);
                });
            }
            
            // Wait for all scripts to load before registering modules
            setTimeout(() => {
                console.log('Starting module registration...');
                console.log('Available classes:', {
                    Artwork1: typeof window.Artwork1,
                    Artwork2: typeof window.Artwork2,
                    Artwork3: typeof window.Artwork3,
                    Artwork4: typeof window.Artwork4,
                    Artwork5: typeof window.Artwork5
                });
                
                // Register artwork1 module
                if (typeof window.Artwork1 !== 'undefined') {
                    console.log('Registering artwork1...');
                    arManager.registerModule('artwork1', Artwork1, {
                        title: '열간 압연 데이터 01: 보정 알고리즘 구조',
                        audioFile: 'https://heund.github.io/ea_test1/sounds/ambient1.mp3'
                    });
                }
                
                // Register artwork2 module
                if (typeof window.Artwork2 !== 'undefined') {
                    console.log('Registering artwork2...');
                    arManager.registerModule('artwork2', Artwork2, {
                        title: '열간 압연 데이터 02: 압연 효율 분포',
                        audioFile: 'https://heund.github.io/ea_test1/sounds/ambient1.mp3'
                    });
                }
                
                // Register artwork3 module
                if (typeof window.Artwork3 !== 'undefined') {
                    console.log('Registering artwork3...');
                    arManager.registerModule('artwork3', Artwork3, {
                        title: '열간 압연 데이터 03: 시계열 구간별 변형 제어값',
                        audioFile: 'https://heund.github.io/ea_test1/sounds/ambient1.mp3'
                    });
                }
                
                // Register artwork4 module
                if (typeof window.Artwork4 !== 'undefined') {
                    console.log('Registering artwork4...');
                    arManager.registerModule('artwork4', Artwork4, {
                        title: '열간 압연 데이터 04: 응력 누적 분포',
                        audioFile: 'https://heund.github.io/ea_test1/sounds/ambient1.mp3'
                    });
                }
                
                // Register artwork5 module
                if (typeof window.Artwork5 !== 'undefined') {
                    console.log('Registering artwork5...');
                    arManager.registerModule('artwork5', Artwork5, {
                        title: '열간 압연 데이터 05: 온도 분포 및 열 전달 분석',
                        audioFile: 'https://heund.github.io/ea_test1/sounds/ambient1.mp3'
                    });
                }
                
                console.log('Module registry:', arManager.moduleRegistry);
            }, 100);
            
            // Setup exit button
            const exitBtn = document.getElementById('exitBtn');
            if (exitBtn) {
                exitBtn.addEventListener('click', function() {
                    // Deactivate current module if active
                    if (arManager.activeModule) {
                        arManager.deactivateCurrentModule();
                    }
                    
                    // Reset AR detection UI - ready for next marker scan
                    const arDetection = document.getElementById('arDetection');
                    const arDetectionBox = document.getElementById('arDetectionBox');
                    
                    // Remove success animation class
                    arDetectionBox.classList.remove('ar-detection-success');
                    
                    // Show the AR detection UI again
                    arDetection.classList.remove('hidden');
                    
                    // Play click sound if available
                    playClickSound();
                    
                    console.log('AR experience reset - ready for next marker scan');
                });
            }
            
            // Setup audio button
            const audioBtn = document.getElementById('audioBtn');
            let audioEnabled = false;
            
            if (audioBtn) {
                audioBtn.addEventListener('click', function() {
                    audioEnabled = !audioEnabled;
                    
                    // Update button icon - now using SVG
                    if (audioEnabled) {
                        // Volume up icon
                        audioBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                            </svg>
                        `;
                    } else {
                        // Volume mute icon
                        audioBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <line x1="23" y1="9" x2="17" y2="15"></line>
                                <line x1="17" y1="9" x2="23" y2="15"></line>
                            </svg>
                        `;
                    }
                    
                    // Toggle audio in active module
                    if (arManager.activeModule) {
                        arManager.activeModule.toggleAudio();
                    }
                    
                    // Play click sound
                    playClickSound();
                });
            }
        });
    </script>
</body>
</html>
